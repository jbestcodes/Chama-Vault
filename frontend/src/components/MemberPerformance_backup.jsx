import React, { useState, useEffect } from 'react';\nimport axios from 'axios';\n\nconst apiUrl = import.meta.env.VITE_API_URL;\n\nconst MemberPerformance = () => {\n    const [memberData, setMemberData] = useState(null);\n    const [performanceData, setPerformanceData] = useState(null);\n    const [loading, setLoading] = useState(true);\n    const [error, setError] = useState('');\n    const [isAdmin, setIsAdmin] = useState(false);\n    const [selectedMemberId, setSelectedMemberId] = useState(null);\n    const [groupMembers, setGroupMembers] = useState([]);\n\n    useEffect(() => {\n        fetchMemberData();\n    }, []);\n\n    useEffect(() => {\n        if (selectedMemberId) {\n            fetchPerformanceData(selectedMemberId);\n        }\n    }, [selectedMemberId]);\n\n    const fetchMemberData = async () => {\n        try {\n            const token = localStorage.getItem('token');\n            const storedMember = JSON.parse(localStorage.getItem('member'));\n            \n            setMemberData(storedMember);\n            setIsAdmin(storedMember?.is_admin || storedMember?.role === 'admin');\n            \n            // If admin, fetch all group members\n            if (storedMember?.is_admin || storedMember?.role === 'admin') {\n                const response = await axios.get(`${apiUrl}/api/groups/${storedMember.group_id}/members`, {\n                    headers: { Authorization: `Bearer ${token}` }\n                });\n                setGroupMembers(response.data.members);\n                setSelectedMemberId(storedMember._id); // Default to current member\n            } else {\n                setSelectedMemberId(storedMember._id);\n            }\n        } catch (error) {\n            console.error('Error fetching member data:', error);\n            setError('Failed to load member data');\n        }\n    };\n\n    const fetchPerformanceData = async (memberId) => {\n        try {\n            setLoading(true);\n            const token = localStorage.getItem('token');\n            const response = await axios.get(`${apiUrl}/api/repayments/combined-performance/${memberId}`, {\n                headers: { Authorization: `Bearer ${token}` }\n            });\n            setPerformanceData(response.data);\n        } catch (error) {\n            console.error('Error fetching performance data:', error);\n            setError('Failed to load performance data');\n        } finally {\n            setLoading(false);\n        }\n    };\n\n    const getPerformanceColor = (rating) => {\n        switch (rating) {\n            case 'excellent': return '#4caf50';\n            case 'good': return '#2196f3';\n            case 'fair': return '#ff9800';\n            case 'poor': return '#f44336';\n            default: return '#9e9e9e';\n        }\n    };\n\n    const getPerformanceIcon = (rating) => {\n        switch (rating) {\n            case 'excellent': return 'ðŸŒŸ';\n            case 'good': return 'ðŸ‘';\n            case 'fair': return 'ðŸ‘Œ';\n            case 'poor': return 'ðŸ“‰';\n            default: return 'â“';\n        }\n    };\n\n    const getRatingDescription = (rating) => {\n        switch (rating) {\n            case 'excellent': return 'Outstanding performance! Consistently early or on-time.';\n            case 'good': return 'Good performance with mostly timely payments.';\n            case 'fair': return 'Average performance with some delays.';\n            case 'poor': return 'Needs improvement - frequent late payments.';\n            default: return 'Not enough data to determine performance.';\n        }\n    };\n\n    if (loading) {\n        return (\n            <div style={{ maxWidth: '800px', margin: '0 auto', padding: '20px', textAlign: 'center' }}>\n                <h2>Loading Member Performance...</h2>\n            </div>\n        );\n    }\n\n    if (error) {\n        return (\n            <div style={{ maxWidth: '800px', margin: '0 auto', padding: '20px' }}>\n                <div style={{ \n                    background: '#ffebee', \n                    color: '#c62828', \n                    padding: '15px', \n                    borderRadius: '8px',\n                    textAlign: 'center'\n                }}>\n                    {error}\n                </div>\n            </div>\n        );\n    }\n\n    return (\n        <div style={{ maxWidth: '800px', margin: '0 auto', padding: '20px' }}>\n            {/* Header */}\n            <div style={{ \n                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',\n                color: 'white',\n                padding: '30px',\n                borderRadius: '15px',\n                marginBottom: '30px',\n                textAlign: 'center'\n            }}>\n                <h1 style={{ margin: '0 0 10px 0', fontSize: '28px' }}>ðŸ“Š Member Performance</h1>\n                <p style={{ margin: 0, opacity: 0.9 }}>Track contribution and loan repayment timing</p>\n            </div>\n\n            {/* Member Selector (Admin Only) */}\n            {isAdmin && groupMembers.length > 0 && (\n                <div style={{ \n                    background: 'white',\n                    border: '1px solid #e1e5e9',\n                    borderRadius: '15px',\n                    padding: '20px',\n                    marginBottom: '30px',\n                    boxShadow: '0 2px 10px rgba(0,0,0,0.05)'\n                }}>\n                    <label style={{ display: 'block', marginBottom: '10px', fontWeight: '500' }}>\n                        Select Member to View:\n                    </label>\n                    <select\n                        value={selectedMemberId || ''}\n                        onChange={(e) => setSelectedMemberId(e.target.value)}\n                        style={{\n                            width: '100%',\n                            padding: '12px',\n                            border: '1px solid #e1e5e9',\n                            borderRadius: '8px',\n                            fontSize: '16px'\n                        }}\n                    >\n                        {groupMembers.map(member => (\n                            <option key={member._id} value={member._id}>\n                                {member.first_name} {member.last_name}\n                            </option>\n                        ))}\n                    </select>\n                </div>\n            )}\n\n            {/* Performance Overview */}\n            {performanceData && (\n                <>\n                    {/* Overall Performance Card */}\n                    <div style={{ \n                        background: 'white',\n                        border: '1px solid #e1e5e9',\n                        borderRadius: '15px',\n                        padding: '30px',\n                        marginBottom: '30px',\n                        boxShadow: '0 2px 10px rgba(0,0,0,0.05)',\n                        textAlign: 'center'\n                    }}>\n                        <h2 style={{ margin: '0 0 20px 0', color: '#333' }}>\n                            {performanceData.member.name}\n                        </h2>\n                        \n                        <div style={{\n                            fontSize: '48px',\n                            marginBottom: '15px'\n                        }}>\n                            {getPerformanceIcon(performanceData.combined_performance.overall_rating)}\n                        </div>\n                        \n                        <div style={{\n                            fontSize: '32px',\n                            fontWeight: 'bold',\n                            color: getPerformanceColor(performanceData.combined_performance.overall_rating),\n                            marginBottom: '10px',\n                            textTransform: 'capitalize'\n                        }}>\n                            {performanceData.combined_performance.overall_rating.replace('_', ' ')}\n                        </div>\n                        \n                        <p style={{ \n                            color: '#666', \n                            fontSize: '16px', \n                            lineHeight: '1.5',\n                            maxWidth: '500px',\n                            margin: '0 auto 20px'\n                        }}>\n                            {getRatingDescription(performanceData.combined_performance.overall_rating)}\n                        </p>\n                        \n                        {performanceData.combined_performance.total_activities > 0 && (\n                            <div style={{\n                                background: '#f8f9fa',\n                                borderRadius: '10px',\n                                padding: '15px',\n                                display: 'inline-block'\n                            }}>\n                                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#667eea' }}>\n                                    {performanceData.combined_performance.overall_score.toFixed(2)}/3.0\n                                </div>\n                                <div style={{ fontSize: '14px', color: '#666' }}>\n                                    Overall Score\n                                </div>\n                                <div style={{ fontSize: '12px', color: '#999', marginTop: '5px' }}>\n                                    Based on {performanceData.combined_performance.total_activities} activities\n                                </div>\n                            </div>\n                        )}\n                    </div>\n\n                    {/* Detailed Performance Breakdown */}\n                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(350px, 1fr))', gap: '20px', marginBottom: '30px' }}>\n                        \n                        {/* Contribution Performance */}\n                        <div style={{ \n                            background: 'white',\n                            border: '1px solid #e1e5e9',\n                            borderRadius: '15px',\n                            padding: '25px',\n                            boxShadow: '0 2px 10px rgba(0,0,0,0.05)'\n                        }}>\n                            <h3 style={{ margin: '0 0 20px 0', color: '#333', display: 'flex', alignItems: 'center', gap: '10px' }}>\n                                ðŸ”„ Table Banking Contributions\n                            </h3>\n                            \n                            {performanceData.contribution_performance.total_rated > 0 ? (\n                                <>\n                                    <div style={{\n                                        display: 'flex',\n                                        justifyContent: 'center',\n                                        alignItems: 'center',\n                                        marginBottom: '20px'\n                                    }}>\n                                        <div style={{\n                                            width: '80px',\n                                            height: '80px',\n                                            borderRadius: '50%',\n                                            background: getPerformanceColor(performanceData.contribution_performance.average_rating),\n                                            display: 'flex',\n                                            alignItems: 'center',\n                                            justifyContent: 'center',\n                                            color: 'white',\n                                            fontSize: '24px',\n                                            fontWeight: 'bold'\n                                        }}>\n                                            {getPerformanceIcon(performanceData.contribution_performance.average_rating)}\n                                        </div>\n                                    </div>\n                                    \n                                    <div style={{ textAlign: 'center', marginBottom: '20px' }}>\n                                        <div style={{\n                                            fontSize: '20px',\n                                            fontWeight: 'bold',\n                                            color: getPerformanceColor(performanceData.contribution_performance.average_rating),\n                                            textTransform: 'capitalize'\n                                        }}>\n                                            {performanceData.contribution_performance.average_rating}\n                                        </div>\n                                        <div style={{ fontSize: '14px', color: '#666' }}>\n                                            Score: {performanceData.contribution_performance.score?.toFixed(2)}/3.0\n                                        </div>\n                                    </div>\n                                    \n                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '10px', marginBottom: '15px' }}>\n                                        <div style={{ textAlign: 'center', padding: '10px', background: '#e8f5e8', borderRadius: '8px' }}>\n                                            <div style={{ fontSize: '18px', fontWeight: 'bold', color: '#4caf50' }}>\n                                                {performanceData.contribution_performance.breakdown.early}\n                                            </div>\n                                            <div style={{ fontSize: '12px', color: '#4caf50' }}>Early</div>\n                                        </div>\n                                        <div style={{ textAlign: 'center', padding: '10px', background: '#fff3cd', borderRadius: '8px' }}>\n                                            <div style={{ fontSize: '18px', fontWeight: 'bold', color: '#ffc107' }}>\n                                                {performanceData.contribution_performance.breakdown.on_time}\n                                            </div>\n                                            <div style={{ fontSize: '12px', color: '#ffc107' }}>On Time</div>\n                                        </div>\n                                        <div style={{ textAlign: 'center', padding: '10px', background: '#f8d7da', borderRadius: '8px' }}>\n                                            <div style={{ fontSize: '18px', fontWeight: 'bold', color: '#dc3545' }}>\n                                                {performanceData.contribution_performance.breakdown.late}\n                                            </div>\n                                            <div style={{ fontSize: '12px', color: '#dc3545' }}>Late</div>\n                                        </div>\n                                    </div>\n                                    \n                                    <div style={{ fontSize: '12px', color: '#666', textAlign: 'center' }}>\n                                        Total Rated: {performanceData.contribution_performance.total_rated} contributions\n                                    </div>\n                                </>\n                            ) : (\n                                <div style={{ textAlign: 'center', padding: '20px', color: '#666' }}>\n                                    <div style={{ fontSize: '48px', marginBottom: '10px' }}>ðŸ“Š</div>\n                                    <p>No contribution data available</p>\n                                </div>\n                            )}\n                        </div>\n\n                        {/* Loan Repayment Performance */}\n                        <div style={{ \n                            background: 'white',\n                            border: '1px solid #e1e5e9',\n                            borderRadius: '15px',\n                            padding: '25px',\n                            boxShadow: '0 2px 10px rgba(0,0,0,0.05)'\n                        }}>\n                            <h3 style={{ margin: '0 0 20px 0', color: '#333', display: 'flex', alignItems: 'center', gap: '10px' }}>\n                                ðŸ’° Loan Repayments\n                            </h3>\n                            \n                            {performanceData.loan_performance.total_rated > 0 ? (\n                                <>\n                                    <div style={{\n                                        display: 'flex',\n                                        justifyContent: 'center',\n                                        alignItems: 'center',\n                                        marginBottom: '20px'\n                                    }}>\n                                        <div style={{\n                                            width: '80px',\n                                            height: '80px',\n                                            borderRadius: '50%',\n                                            background: getPerformanceColor(performanceData.loan_performance.average_rating),\n                                            display: 'flex',\n                                            alignItems: 'center',\n                                            justifyContent: 'center',\n                                            color: 'white',\n                                            fontSize: '24px',\n                                            fontWeight: 'bold'\n                                        }}>\n                                            {getPerformanceIcon(performanceData.loan_performance.average_rating)}\n                                        </div>\n                                    </div>\n                                    \n                                    <div style={{ textAlign: 'center', marginBottom: '20px' }}>\n                                        <div style={{\n                                            fontSize: '20px',\n                                            fontWeight: 'bold',\n                                            color: getPerformanceColor(performanceData.loan_performance.average_rating),\n                                            textTransform: 'capitalize'\n                                        }}>\n                                            {performanceData.loan_performance.average_rating}\n                                        </div>\n                                        <div style={{ fontSize: '14px', color: '#666' }}>\n                                            Score: {performanceData.loan_performance.score?.toFixed(2)}/3.0\n                                        </div>\n                                    </div>\n                                    \n                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '10px', marginBottom: '15px' }}>\n                                        <div style={{ textAlign: 'center', padding: '10px', background: '#e8f5e8', borderRadius: '8px' }}>\n                                            <div style={{ fontSize: '18px', fontWeight: 'bold', color: '#4caf50' }}>\n                                                {performanceData.loan_performance.breakdown.early}\n                                            </div>\n                                            <div style={{ fontSize: '12px', color: '#4caf50' }}>Early</div>\n                                        </div>\n                                        <div style={{ textAlign: 'center', padding: '10px', background: '#fff3cd', borderRadius: '8px' }}>\n                                            <div style={{ fontSize: '18px', fontWeight: 'bold', color: '#ffc107' }}>\n                                                {performanceData.loan_performance.breakdown.on_time}\n                                            </div>\n                                            <div style={{ fontSize: '12px', color: '#ffc107' }}>On Time</div>\n                                        </div>\n                                        <div style={{ textAlign: 'center', padding: '10px', background: '#f8d7da', borderRadius: '8px' }}>\n                                            <div style={{ fontSize: '18px', fontWeight: 'bold', color: '#dc3545' }}>\n                                                {performanceData.loan_performance.breakdown.late}\n                                            </div>\n                                            <div style={{ fontSize: '12px', color: '#dc3545' }}>Late</div>\n                                        </div>\n                                    </div>\n                                    \n                                    <div style={{ fontSize: '12px', color: '#666', textAlign: 'center' }}>\n                                        Total Rated: {performanceData.loan_performance.total_rated} repayments<br/>\n                                        Avg Days Late: {performanceData.loan_performance.average_days_late?.toFixed(1)} days\n                                    </div>\n                                </>\n                            ) : (\n                                <div style={{ textAlign: 'center', padding: '20px', color: '#666' }}>\n                                    <div style={{ fontSize: '48px', marginBottom: '10px' }}>ðŸ’°</div>\n                                    <p>No loan repayment data available</p>\n                                </div>\n                            )}\n                        </div>\n                    </div>\n                    \n                    {/* Performance Tips */}\n                    {performanceData.combined_performance.overall_rating !== 'excellent' && (\n                        <div style={{ \n                            background: '#e3f2fd',\n                            border: '1px solid #2196f3',\n                            borderRadius: '15px',\n                            padding: '20px',\n                            marginBottom: '20px'\n                        }}>\n                            <h3 style={{ margin: '0 0 15px 0', color: '#1976d2', display: 'flex', alignItems: 'center', gap: '10px' }}>\n                                ðŸ’¡ Tips to Improve Performance\n                            </h3>\n                            <ul style={{ margin: 0, color: '#1976d2', lineHeight: '1.6' }}>\n                                {performanceData.contribution_performance.total_rated === 0 && (\n                                    <li>Start participating in table banking contributions to build your payment history</li>\n                                )}\n                                {performanceData.loan_performance.total_rated === 0 && performanceData.contribution_performance.average_rating === 'excellent' && (\n                                    <li>Your contribution performance is excellent! You may be eligible for loans.</li>\n                                )}\n                                {performanceData.combined_performance.overall_rating === 'poor' && (\n                                    <li>Set up payment reminders to avoid late payments</li>\n                                )}\n                                {(performanceData.combined_performance.overall_rating === 'fair' || performanceData.combined_performance.overall_rating === 'poor') && (\n                                    <li>Try to make payments a few days before the due date</li>\n                                )}\n                                <li>Consistent early or on-time payments improve your group standing and loan eligibility</li>\n                            </ul>\n                        </div>\n                    )}\n                </>\n            )}\n        </div>\n    );\n};\n\nexport default MemberPerformance;